<%- include('../partials/header') %>

<% const currentYear = new Date().getFullYear(); %>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">Quản Lý Học Phí</h1>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <form id="filterForm" method="GET" action="/teacher/tuition" class="row g-3">
                        <div class="col-md-4">
                            <label for="scheduleId" class="form-label">Lớp học</label>
                            <select class="form-select" id="scheduleId" name="scheduleId" onchange="this.form.submit()">
                                <% if (schedules.length === 0) { %>
                                    <option value="">Không có lớp</option>
                                <% } else { %>
                                    <% schedules.forEach(schedule => { %>
                                        <option value="<%= schedule._id %>" <%= selectedScheduleId && selectedScheduleId.toString() === schedule._id.toString() ? 'selected' : '' %>><%= schedule.name %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="month" class="form-label">Tháng</label>
                            <select class="form-select" id="month" name="month" onchange="this.form.submit()">
                                <% for (let i = 1; i <= 12; i++) { %>
                                    <option value="<%= i %>" <%= selectedMonth === i ? 'selected' : '' %>><%= i %></option>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="year" class="form-label">Năm</label>
                            <select class="form-select" id="year" name="year" onchange="this.form.submit()">
                                <% for (let i = currentYear - 2; i <= currentYear + 1; i++) { %>
                                    <option value="<%= i %>" <%= selectedYear === i ? 'selected' : '' %>><%= i %></option>
                                <% } %>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Thẻ thống kê -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card card-tuition">
                <div class="card-body">
                    <h5 class="card-title">Tổng Học Phí</h5>
                    <h3 class="card-text text-primary">
                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(tuitionStats.total) %>
                    </h3>
                    <p class="card-text text-muted">
                        <small>Tháng <%= selectedMonth %>/<%= selectedYear %></small>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stats-card card-paid">
                <div class="card-body">
                    <h5 class="card-title">Đã Thanh Toán</h5>
                    <h3 class="card-text text-success">
                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(tuitionStats.paid) %>
                    </h3>
                    <p class="card-text text-muted">
                        <small><%= tuitionStats.paidCount || 0 %> phiếu học phí</small>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stats-card card-pending">
                <div class="card-body">
                    <h5 class="card-title">Chưa Thanh Toán</h5>
                    <h3 class="card-text text-warning">
                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(tuitionStats.pending) %>
                    </h3>
                    <p class="card-text text-muted">
                        <small><%= tuitionStats.pendingCount || 0 %> phiếu học phí</small>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stats-card card-overdue">
                <div class="card-body">
                    <h5 class="card-title">Quá Hạn</h5>
                    <h3 class="card-text text-danger">
                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(tuitionStats.overdue) %>
                    </h3>
                    <p class="card-text text-muted">
                        <small><%= tuitionStats.overdueCount || 0 %> phiếu học phí</small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <% if (selectedSchedule) { %>
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent py-3 border-bottom-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Thông Tin Lớp Học</h5>
                    <div>
                        <button class="btn btn-primary" id="generateTuitionBtn">
                            <i class="bi bi-plus-circle me-1"></i> Tạo Học Phí Hàng Loạt
                        </button>
                        <button class="btn btn-success" id="addManualTuitionBtn">
                            <i class="bi bi-plus me-1"></i> Thêm Học Phí Thủ Công
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Tên lớp:</strong> <%= selectedSchedule.name %></p>
                            <p><strong>Số học sinh:</strong> <%= tuitionStats.totalCount %> học sinh</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Lịch học:</strong> 
                                <% 
                                let dayText = '';
                                if (selectedSchedule.days && selectedSchedule.days.length > 0) {
                                    const dayMap = {
                                        'monday': 'Thứ 2',
                                        'tuesday': 'Thứ 3', 
                                        'wednesday': 'Thứ 4',
                                        'thursday': 'Thứ 5',
                                        'friday': 'Thứ 6',
                                        'saturday': 'Thứ 7',
                                        'sunday': 'Chủ nhật'
                                    };
                                    dayText = selectedSchedule.days.map(day => dayMap[day.toLowerCase()] || day).join(', ');
                                } else if (selectedSchedule.dayOfWeek) {
                                    const daysOfWeek = ['Chủ nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
                                    
                                    if (Array.isArray(selectedSchedule.dayOfWeek)) {
                                        dayText = selectedSchedule.dayOfWeek.map(day => {
                                            // Xử lý trường hợp day là số
                                            const index = parseInt(day);
                                            return isNaN(index) ? day : daysOfWeek[index];
                                        }).join(', ');
                                    } else {
                                        // Xử lý trường hợp dayOfWeek là số đơn lẻ
                                        dayText = daysOfWeek[selectedSchedule.dayOfWeek];
                                    }
                                } else {
                                    dayText = 'Chưa cập nhật';
                                }
                                %>
                                <%= dayText %>
                            </p>
                            <p><strong>Giờ học:</strong> 
                                <% 
                                let timeText = '';
                                if (selectedSchedule.time && selectedSchedule.time.start && selectedSchedule.time.end) {
                                    timeText = `${selectedSchedule.time.start} - ${selectedSchedule.time.end}`;
                                } else if (selectedSchedule.startTime && selectedSchedule.endTime) {
                                    timeText = `${selectedSchedule.startTime} - ${selectedSchedule.endTime}`;
                                }
                                %>
                                <%= timeText %>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <% } %>

    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-transparent py-3 border-bottom-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh Sách Học Phí</h5>
                </div>
                <div class="card-body">
                    <% console.log('Dữ liệu học phí trong view:', { 
                        tuitions: tuitions,
                        count: tuitions.length,
                        selectedScheduleId: selectedScheduleId,
                        month: selectedMonth,
                        year: selectedYear
                    }); %>
                    <% if (tuitions.length === 0) { %>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i> Không có khoản học phí nào trong tháng/năm đã chọn.
                        </div>
                    <% } else { %>
                        <div class="tuition-grid">
                            <div class="row">
                                <% tuitions.forEach(tuition => { %>
                                    <div class="col-md-3 col-sm-6 mb-4">
                                        <div class="card tuition-card h-100">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="mb-0 text-truncate" title="<%= tuition.student ? tuition.student.name : 'Học sinh không xác định' %>">
                                                        <%= tuition.student ? tuition.student.name : 'Học sinh không xác định' %>
                                                    </h6>
                                                    <% 
                                                    let statusClass = '';
                                                    let statusText = '';
                                                    let badgeClass = '';
                                                    
                                                    if (tuition.status === 'paid') {
                                                        statusClass = 'status-paid';
                                                        statusText = 'Đã TT';
                                                        badgeClass = 'badge-paid';
                                                    } else {
                                                        const dueDate = new Date(tuition.dueDate);
                                                        const today = new Date();
                                                        
                                                        if (today > dueDate || tuition._displayStatus === 'overdue') {
                                                            statusClass = 'status-overdue';
                                                            statusText = 'Quá hạn';
                                                            badgeClass = 'badge-overdue';
                                                        } else {
                                                            statusClass = 'status-pending';
                                                            statusText = 'Chưa TT';
                                                            badgeClass = 'badge-pending';
                                                        }
                                                    }
                                                    %>
                                                    <span class="badge badge-custom <%= badgeClass %>">
                                                        <%= statusText %>
                                                    </span>
                                                </div>
                                                
                                                <div class="student-info small mb-2">
                                                    <div><strong>Học phí:</strong> <%= tuition.amount.toLocaleString('vi-VN') %> ₫</div>
                                                    <div class="mt-1">
                                                        <strong>Ghi chú:</strong> 
                                                        <% if (tuition.notes && tuition.notes.trim() !== '') { %>
                                                            <span class="text-muted"><%= tuition.notes %></span>
                                                        <% } %>
                                                    </div>
                                                </div>
                                                
                                                <div class="d-flex justify-content-between mt-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input payment-status-checkbox" type="checkbox" 
                                                               id="payment<%= tuition._id %>" 
                                                               data-id="<%= tuition._id %>"
                                                               data-student="<%= tuition.student ? tuition.student.name : 'Học sinh' %>"
                                                               <%= tuition.status === 'paid' ? 'checked' : '' %>>
                                                        <label class="form-check-label small" for="payment<%= tuition._id %>">
                                                            Đã thanh toán
                                                        </label>
                                                    </div>
                                                    
                                                    <div class="tuition-actions">
                                                        <button type="button" class="btn btn-sm btn-info edit-note" data-id="<%= tuition._id %>" data-notes="<%= tuition.notes || '' %>" data-status="<%= tuition.status %>">
                                                            <i class="bi bi-sticky"></i>  
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-danger delete-tuition" data-id="<%= tuition._id %>">
                                                            <i class="bi bi-trash"></i> Xóa
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ghi nhận thanh toán -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/teacher/tuition/payment" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Ghi nhận thanh toán học phí</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="tuitionId" name="tuitionId">
                    
                    <div class="mb-3">
                        <label for="studentName" class="form-label">Học sinh</label>
                        <input type="text" class="form-control" id="studentName" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="amount" class="form-label">Số tiền</label>
                        <input type="text" class="form-control" id="amount" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dueDate" class="form-label">Hạn thanh toán</label>
                        <input type="text" class="form-control" id="dueDate" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="paymentDate" class="form-label">Ngày thanh toán</label>
                        <input type="date" class="form-control" id="paymentDate" name="paymentDate" 
                               value="<%= new Date().toISOString().split('T')[0] %>" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Phương thức thanh toán</label>
                        <select class="form-select" id="paymentMethod" name="paymentMethod" required>
                            <option value="cash">Tiền mặt</option>
                            <option value="transfer">Chuyển khoản</option>
                            <option value="card">Thẻ</option>
                            <option value="other">Khác</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Ghi chú</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success">Xác nhận thanh toán</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal tạo học phí hàng loạt -->
<div class="modal fade" id="generateTuitionModal" tabindex="-1" aria-labelledby="generateTuitionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateTuitionModalLabel">Tạo học phí hàng loạt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="generateTuitionForm">
                    <input type="hidden" id="modalScheduleId" value="<%= selectedScheduleId %>">
                    
                    <div class="mb-3">
                        <label for="modalMonth" class="form-label">Tháng</label>
                        <select class="form-select" id="modalMonth">
                            <% for(let i = 1; i <= 12; i++) { %>
                                <option value="<%= i %>" <%= selectedMonth == i ? 'selected' : '' %>>
                                    Tháng <%= i %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalYear" class="form-label">Năm</label>
                        <select class="form-select" id="modalYear">
                            <% 
                            for(let i = currentYear - 2; i <= currentYear + 2; i++) { 
                            %>
                                <option value="<%= i %>" <%= selectedYear == i ? 'selected' : '' %>>
                                    <%= i %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalAmount" class="form-label">Số tiền học phí</label>
                        <input type="text" class="form-control money-input" id="modalAmount" 
                            value="<%= (selectedSchedule?.tuitionAmount || 0).toLocaleString('vi-VN') %>" min="0" step="10000">
                        <small class="form-text text-muted">Nhập số tiền học phí cho mỗi học sinh</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalDueDay" class="form-label">Ngày đến hạn</label>
                        <input type="number" class="form-control" id="modalDueDay" 
                            value="<%= selectedSchedule?.tuitionDueDay || 10 %>" min="1" max="31">
                        <small class="form-text text-muted">Ngày đến hạn thanh toán trong tháng</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalName" class="form-label">Tên khoản học phí</label>
                        <input type="text" class="form-control" id="modalName" 
                            value="Học phí tháng <%= selectedMonth %>/<%= selectedYear %> - <%= selectedSchedule ? selectedSchedule.name : '' %>">
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalStatus" class="form-label">Trạng thái thanh toán</label>
                        <select class="form-select" id="modalStatus">
                            <option value="pending" selected>Chưa thanh toán</option>
                            <option value="paid">Đã thanh toán</option>
                        </select>
                        <small class="form-text text-muted">Chọn trạng thái thanh toán cho tất cả học phí được tạo</small>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i> Học phí sẽ được tạo cho tất cả học sinh trong lớp với trạng thái đã chọn.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="confirmGenerateTuition">Tạo học phí</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal tạo học phí thủ công -->
<div class="modal fade" id="manualTuitionModal" tabindex="-1" aria-labelledby="manualTuitionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="manualTuitionModalLabel">Thêm học phí thủ công</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="manualTuitionForm">
                    <input type="hidden" name="scheduleId" id="manualScheduleId" value="<%= selectedScheduleId %>">
                    
                    <div class="mb-3">
                        <label for="studentId" class="form-label">Học sinh</label>
                        <select class="form-select" id="studentId" name="studentId" required>
                            <option value="">-- Chọn học sinh --</option>
                            <% if (selectedSchedule && selectedSchedule.enrollments && selectedSchedule.enrollments.length > 0) { %>
                                <% selectedSchedule.enrollments.forEach(enrollment => { 
                                    if (enrollment.student) { %>
                                    <option value="<%= enrollment.student._id %>"><%= enrollment.student.name %></option>
                                <% }}) %>
                            <% } %>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualAmount" class="form-label">Số tiền</label>
                        <input type="text" class="form-control money-input" id="manualAmount" name="amount" 
                            value="<%= (selectedSchedule?.tuitionAmount || 0).toLocaleString('vi-VN') %>" min="0" step="10000" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualMonth" class="form-label">Tháng</label>
                        <select class="form-select" id="manualMonth" name="month">
                            <% for(let i = 1; i <= 12; i++) { %>
                                <option value="<%= i %>" <%= selectedMonth == i ? 'selected' : '' %>>Tháng <%= i %></option>
                            <% } %>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualYear" class="form-label">Năm</label>
                        <select class="form-select" id="manualYear" name="year">
                            <% for(let i = currentYear - 2; i <= currentYear + 2; i++) { %>
                                <option value="<%= i %>" <%= selectedYear == i ? 'selected' : '' %>><%= i %></option>
                            <% } %>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualDueDay" class="form-label">Ngày đến hạn</label>
                        <input type="number" class="form-control" id="manualDueDay" name="dueDay" 
                            value="<%= selectedSchedule?.tuitionDueDay || 10 %>" min="1" max="31" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualName" class="form-label">Tên khoản học phí</label>
                        <input type="text" class="form-control" id="manualName" name="name" 
                            value="Học phí tháng <%= selectedMonth %>/<%= selectedYear %> - <%= selectedSchedule ? selectedSchedule.name : '' %>" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualStatus" class="form-label">Trạng thái</label>
                        <select class="form-select" id="manualStatus" name="status">
                            <option value="pending" selected>Chưa thanh toán</option>
                            <option value="paid">Đã thanh toán</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualNotes" class="form-label">Ghi chú</label>
                        <textarea class="form-control" id="manualNotes" name="notes" rows="3" placeholder="Ghi chú (không bắt buộc)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success" id="saveManualTuition">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit Tuition -->
<div class="modal fade" id="editTuitionModal" tabindex="-1" aria-labelledby="editTuitionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTuitionModalLabel">Chỉnh sửa học phí</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editTuitionForm">
          <input type="hidden" id="editTuitionId" name="tuitionId">
          
          <div class="mb-3">
            <label for="editStudentName" class="form-label">Học sinh</label>
            <input type="text" class="form-control" id="editStudentName" disabled>
          </div>
          
          <div class="mb-3">
            <label for="editAmount" class="form-label">Số tiền</label>
            <input type="text" class="form-control money-input" id="editAmount" name="amount">
          </div>
          
          <div class="mb-3">
            <label for="editDueDay" class="form-label">Ngày hết hạn</label>
            <input type="date" class="form-control" id="editDueDay" name="dueDay">
          </div>
          
          <div class="mb-3">
            <label for="editNotes" class="form-label">Ghi chú</label>
            <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
          </div>
          
          <div class="mb-3">
            <label for="editStatus" class="form-label">Trạng thái</label>
            <select class="form-select" id="editStatus" name="status">
              <option value="pending">Chưa thanh toán</option>
              <option value="paid">Đã thanh toán</option>
              <option value="overdue">Quá hạn</option>
            </select>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Notes -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notesModalLabel">Cập nhật ghi chú</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="notesForm">
          <input type="hidden" id="notesTuitionId">
          <div class="mb-3">
            <label for="notesText" class="form-label">Ghi chú</label>
            <textarea class="form-control" id="notesText" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" id="saveNoteBtn">Lưu</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal xác nhận xóa học phí -->
<div class="modal fade" id="deleteTuitionModal" tabindex="-1" aria-labelledby="deleteTuitionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTuitionModalLabel">Xác nhận xóa học phí</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa học phí của <span id="deleteTuitionStudentName"></span>?</p>
                <p class="text-danger">Lưu ý: Hành động này không thể hoàn tác.</p>
                <input type="hidden" id="deleteTuitionId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTuition">Xóa</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Hàm định dạng tiền tệ
        function formatMoney(input) {
            // Xóa tất cả ký tự không phải số
            let value = input.value.replace(/\D/g, '');
            // Định dạng với dấu phân cách hàng nghìn
            if (value !== '') {
                input.value = new Intl.NumberFormat('vi-VN').format(value);
            }
        }
        
        // Hàm chuẩn bị giá trị tiền tệ khi submit
        function prepareMoneyInput(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = input.value.replace(/\D/g, '');
            }
        }
        
        // Áp dụng định dạng tiền tệ cho tất cả input có class money-input
        document.querySelectorAll('.money-input').forEach(input => {
            input.addEventListener('input', function() {
                formatMoney(this);
            });
            
            // Định dạng ban đầu nếu đã có giá trị
            if (input.value) {
                formatMoney(input);
            }
        });
        
        // Chuẩn bị dữ liệu trước khi submit form
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                document.querySelectorAll('.money-input').forEach(input => {
                    input.value = input.value.replace(/\D/g, '');
                });
            });
        });
        
        // Xử lý khi submit form tạo học phí hàng loạt
        if (document.getElementById('confirmGenerateTuition')) {
            document.getElementById('confirmGenerateTuition').addEventListener('click', function() {
                const modalAmountInput = document.getElementById('modalAmount');
                if (modalAmountInput) {
                    modalAmountInput.value = modalAmountInput.value.replace(/\D/g, '');
                }
            });
        }
        
        // Xử lý khi submit form tạo học phí thủ công
        if (document.getElementById('saveManualTuition')) {
            document.getElementById('saveManualTuition').addEventListener('click', function() {
                const manualAmountInput = document.getElementById('manualAmount');
                if (manualAmountInput) {
                    manualAmountInput.value = manualAmountInput.value.replace(/\D/g, '');
                }
            });
        }
        
        // Xử lý khi submit form chỉnh sửa học phí
        if (document.getElementById('saveEditTuition')) {
            document.getElementById('saveEditTuition').addEventListener('click', function() {
                const editAmountInput = document.getElementById('editAmount');
                if (editAmountInput) {
                    editAmountInput.value = editAmountInput.value.replace(/\D/g, '');
                }
            });
        }
        
        // Xử lý khi click vào nút thanh toán
        document.querySelectorAll('.record-payment-btn').forEach(button => {
            button.addEventListener('click', function() {
                const tuitionId = this.getAttribute('data-id');
                const studentName = this.getAttribute('data-student');
                const amount = parseFloat(this.getAttribute('data-amount'));
                const dueDate = this.getAttribute('data-due-date');
                
                document.getElementById('tuitionId').value = tuitionId;
                document.getElementById('studentName').value = studentName;
                document.getElementById('amount').value = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
                document.getElementById('dueDate').value = dueDate;
            });
        });
        
        // Xử lý khi click vào nút tạo học phí hàng loạt
        const generateTuitionBtn = document.getElementById('generateTuitionBtn');
        if (generateTuitionBtn) {
            generateTuitionBtn.addEventListener('click', function() {
                const generateTuitionModal = new bootstrap.Modal(document.getElementById('generateTuitionModal'));
                generateTuitionModal.show();
            });
        }
        
        // Xử lý khi click vào nút tạo học phí thủ công
        const addManualTuitionBtn = document.getElementById('addManualTuitionBtn');
        if (addManualTuitionBtn) {
            addManualTuitionBtn.addEventListener('click', function() {
                const manualTuitionModal = new bootstrap.Modal(document.getElementById('manualTuitionModal'));
                manualTuitionModal.show();
            });
        }
        
        // Xử lý sự kiện khi thay đổi checkbox thanh toán
        document.querySelectorAll('.payment-status-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const tuitionId = this.getAttribute('data-id');
                const status = this.checked ? 'paid' : 'pending';
                
                // Cập nhật trạng thái học phí
                fetch('/teacher/tuition/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tuitionId: tuitionId,
                        status: status
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Hiển thị thông báo thành công
                        const toast = `
                            <div class="toast-container position-fixed bottom-0 end-0 p-3">
                                <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                                    <div class="toast-header">
                                        <strong class="me-auto">Thông báo</strong>
                                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                                    </div>
                                    <div class="toast-body">
                                        ${data.message}
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.insertAdjacentHTML('beforeend', toast);
                        const toastEl = document.querySelector('.toast');
                        const bsToast = new bootstrap.Toast(toastEl);
                        bsToast.show();
                        
                        // Cập nhật lại giao diện sau 1 giây
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        alert('Lỗi: ' + data.message);
                        // Đặt lại checkbox nếu có lỗi
                        this.checked = !this.checked;
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi cập nhật trạng thái học phí:', error);
                    alert('Đã xảy ra lỗi khi cập nhật trạng thái học phí');
                    this.checked = !this.checked;
                });
            });
        });
        
        // Xử lý sự kiện khi click vào nút chỉnh sửa học phí
        document.querySelectorAll('.edit-tuition').forEach(button => {
            button.addEventListener('click', function() {
                const tuitionId = this.getAttribute('data-id');
                const amount = this.getAttribute('data-amount');
                const dueDate = this.getAttribute('data-due-date');
                const notes = this.getAttribute('data-notes');
                const status = this.getAttribute('data-status');
                
                // Điền dữ liệu vào form
                document.getElementById('editTuitionId').value = tuitionId;
                document.getElementById('editAmount').value = parseInt(amount).toLocaleString('vi-VN');
                document.getElementById('editDueDay').value = dueDate;
                document.getElementById('editNotes').value = notes;
                document.getElementById('editStatus').value = status;
                
                // Hiển thị modal
                const editTuitionModal = new bootstrap.Modal(document.getElementById('editTuitionModal'));
                editTuitionModal.show();
            });
        });
        
        // Xử lý sự kiện khi click vào nút xóa học phí
        document.querySelectorAll('.delete-tuition').forEach(button => {
            button.addEventListener('click', function() {
                const tuitionId = this.getAttribute('data-id');
                const studentName = this.getAttribute('data-student');
                
                // Điền dữ liệu vào modal
                document.getElementById('deleteTuitionId').value = tuitionId;
                document.getElementById('deleteTuitionStudentName').textContent = studentName;
                
                // Hiển thị modal
                const deleteTuitionModal = new bootstrap.Modal(document.getElementById('deleteTuitionModal'));
                deleteTuitionModal.show();
            });
        });
        
        // Xử lý sự kiện khi click vào nút xác nhận xóa học phí
        document.getElementById('confirmDeleteTuition').addEventListener('click', function() {
            const tuitionId = document.getElementById('deleteTuitionId').value;
            
            // Gửi request xóa học phí
            fetch('/teacher/tuition/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tuitionId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    // Đóng modal và reload trang
                    bootstrap.Modal.getInstance(document.getElementById('deleteTuitionModal')).hide();
                    window.location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Lỗi khi xóa học phí:', error);
                alert('Đã xảy ra lỗi khi xóa học phí');
            });
        });
        
        // Khi người dùng nhấp vào biểu tượng ghi chú
        document.querySelectorAll('.edit-note').forEach(button => {
            button.addEventListener('click', function() {
                const tuitionId = this.getAttribute('data-id');
                const currentNotes = this.getAttribute('data-notes') || '';
                
                // Đặt giá trị cho modal
                document.getElementById('notesTuitionId').value = tuitionId;
                document.getElementById('notesText').value = currentNotes;
                
                // Hiển thị modal
                const notesModal = new bootstrap.Modal(document.getElementById('notesModal'));
                notesModal.show();
            });
        });
        
        // Xử lý khi lưu ghi chú
        document.getElementById('saveNoteBtn').addEventListener('click', async function() {
            const tuitionId = document.getElementById('notesTuitionId').value;
            const notes = document.getElementById('notesText').value;
            
            try {
                const response = await fetch('/teacher/tuition/update-note', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tuitionId, notes })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Đóng modal
                    const notesModal = bootstrap.Modal.getInstance(document.getElementById('notesModal'));
                    notesModal.hide();
                    
                    // Hiển thị thông báo thành công và làm mới trang
                    alert('Đã cập nhật ghi chú thành công');
                    window.location.reload();
                } else {
                    alert(data.message || 'Đã xảy ra lỗi khi cập nhật ghi chú');
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật ghi chú:', error);
                alert('Đã xảy ra lỗi khi cập nhật ghi chú');
            }
        });
        
        // Hàm chuyển đổi trạng thái thành văn bản
        function getStatusText(status) {
            switch (status) {
                case 'paid':
                    return 'Đã thanh toán';
                case 'pending':
                    return 'Chưa thanh toán';
                case 'overdue':
                    return 'Quá hạn';
                default:
                    return 'Không xác định';
            }
        }
    });
</script>

<style>
    .stats-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        margin-bottom: 20px;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    
    .card-tuition {
        border-left: 4px solid #3498db;
    }
    
    .card-paid {
        border-left: 4px solid #2ecc71;
    }
    
    .card-pending {
        border-left: 4px solid #f39c12;
    }
    
    .card-overdue {
        border-left: 4px solid #e74c3c;
    }
    
    .status-paid {
        color: #2ecc71;
        font-weight: bold;
    }
    
    .status-pending {
        color: #f39c12;
        font-weight: bold;
    }
    
    .status-overdue {
        color: #e74c3c;
        font-weight: bold;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(52, 152, 219, 0.1);
    }
    
    .thead-light {
        background-color: #f8f9fa;
    }
    
    .tuition-grid {
        margin-top: 20px;
    }
    
    .tuition-card {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.2s;
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    
    .tuition-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .badge-custom {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85em;
    }
    
    .badge-paid {
        background-color: #d4edda;
        color: #155724;
    }
    
    .badge-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .badge-overdue {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .tuition-actions .btn {
        padding: 0.2rem 0.4rem;
        margin-left: 0.25rem;
    }
    
    .tuition-actions .btn i {
        font-size: 0.9rem;
    }
</style>

<%- include('../partials/footer') %> 